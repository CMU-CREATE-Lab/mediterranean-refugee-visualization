<!doctype html>
<html>
  <head>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <title>Refugees by Mediterranean Sea</title>
    <link rel="stylesheet" type="text/css" href="style.css">

    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDC5znDfzJNHdK_Bc9jTPIVS4BUZhYeOAA"></script>
    <script type="text/javascript" src="js/CanvasLayer.js"></script>
    <script type="text/javascript" src="js/quadraticBezier.js"></script>
    <script type="text/javascript" src="js/LatLon.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script type="text/javascript" src="js/rAF.js"></script>
    <script type="text/javascript" src="js/chroma.js"></script>
    <script type="text/javascript" src="js/Glb.js"></script>
    
      
    <script id="point-vertex-shader" type="x-shader/x-vertex">
      attribute vec4 aStartPoint; 
      attribute vec4 aEndPoint; 
      attribute vec4 aMidPoint; 
      attribute float aEpoch;
      attribute float aSpan;
      //attribute float aCoo;
      //attribute float aCor;

      uniform float uSize;
      uniform float uEpoch;
      //uniform float uSpan;
      uniform mat4 uMapMatrix;

      vec4 bezierCurve(float t, vec4 P0, vec4 P1, vec4 P2) {
        return (1.0-t)*(1.0-t)*P0 + 2.0*(1.0-t)*t*P1 + t*t*P2;
        //return vec4((1.0 - t)*P0 + t*P2);
        //return P0;
      }

      void main() {
        vec4 position;
        if (uEpoch < aEpoch || (uEpoch > aEpoch + aSpan)) {
          position = vec4(-1,-1,-1,-1);
        } else {
          float t = (uEpoch - aEpoch)/aSpan;
          vec4 pos = bezierCurve(t, aStartPoint, aMidPoint, aEndPoint);
          position = uMapMatrix * vec4(pos.x, pos.y, 0, 1);
        }

        gl_Position = position;
        gl_PointSize = uSize;
        //gl_PointSize = 3.;

      }
    </script>
      
      
    <script id="point-fragment-shader" type="x-shader/x-fragment">
      precision mediump float;

      void main() {
          float dist = length(gl_PointCoord.xy - vec2(.5, .5));
          dist = 1. - (dist * 2.);
          dist = max(0., dist);
          gl_FragColor = vec4(1., 0., 0., 1.) * dist;
      }
    </script>
      
      
    <script type="text/javascript">
      var map;
      var circleLayer;
      var circleContext;
      var particleLayer;
      var gl;
      var resolutionScale = window.devicePixelRatio || 1;
      var pixelsToWebGLMatrix = new Float32Array(16);
      var mapMatrix = new Float32Array(16);
      var program;
        
      var refugees = {
        geo_url: './geo_data/geo_data.json',
        draw_url: './json_store/processed_data.json',
        deaths_url: './json_store/death.json',
        particle_url: './particles.bin',
        ready: false,
        pointCount: 0,
        data: null,
        arrayBuffer: null,
        geo_data: {},
        draw_data: {},
        prev_shown: {},
        paths: {},
        deaths: {},
        particles: null,
        largestValue: {},
        largestOfAll: 0
      };
        
      var playBack = {
          playing: false,
          player: null,
          mouseDown: false,
          timeline: new Timeline(),
          cursor: null,
          cursorLine: null
      }
     
      
      var drawBack = {
          MAX_RADIUS: 3,
          BASE_RADIUS: .25,
          BASE_STROKE: .15,
          MAX_AMOUNT: 30000,
          origin_interpolate: 25,
          asylum_interpolate: 10,
          hover: {},
          lasthover: null,
          infowindow: null,
          animateParticles: false,
          animationRequestID: null,
          colors: (function(){
              var colors = [];
              var color = chroma('teal');
              var leftVal = .2;
              var rightVal = .9;
              for(var i = leftVal; i < rightVal; i+= .01){
                  colors.push(color.luminance(i, 'hsl').css());
              }
              for(var i = rightVal; i > leftVal; i-= .01){
                  colors.push(color.luminance(i, 'hsl').css());
              }
              return colors;
          })()
      }
        
      function Date_M_Y(month, year){
          this.month = month;
          this.year = year;
      }
        
      var timeEnum = {
          oneHour: 60*60,
          twoHours: 2*60*60,
          threeHours: 3*60*60,
          sixHours: 6*60*60,
          oneDay: 24*60*60,
          twoDays: 2*24*60*60
      }
      
      function Timeline(){
          this.currentTime = 0;
          this.startTime = 0;
          this.endTime = 0;
          this.increment = 3*60*60;
          this.playing = false;
      }
        
      (function(){
        this.incrementTime = function() {
            this.currentTime += this.increment;
        };
        this.setDate = function(date){
            var startOfMonth = new Date(date.year, date.month-1, 1, 0, 0, 0);
            var startOfNextMonth = new Date(date.year, date.month, 1, 0, 0, 0);
            this.currentTime = this.startTime = (startOfMonth.getTime() - startOfMonth.getTimezoneOffset()*60000)/1000;
            this.endTime = (startOfNextMonth.getTime() - startOfNextMonth.getTimezoneOffset()*60000)/1000;
        };
        this.resetMonth = function(){
            this.currentTime = this.endTime;
        };
        this.isFinished = function(){
            return (this.currentTime >= this.endTime);
        }
        this.animate = function(){
            if(this.animating){
                this.incrementTime();
                if(this.isFinished()){
                    if(this.playing){
                        incrementMonth();
                    }else{
                        this.resetMonth();
                        this.animating = false;
                    }

                }
                this.updateCursor();
            }
            particleLayer.setAnimate(this.animating);
        };
        this.startAnimation = function(){
            this.animating = true;
            particleLayer.setAnimate(true);
        }
        
        this.updateCursor = function(){
           playBack.cursorLine.css('left', Math.round(((this.currentTime - this.startTime) / (this.endTime - this.startTime))*100) + '%');
        };
      }).call(Timeline.prototype)
        
     
      function calculateRadius(amount){
          return drawBack.particle_size;
      }
    
      function upDate(){
        refugees.currentDate = new Date_M_Y($('.cursor').data('month'), $('.cursor').parent().data('year'));
        playBack.cursor = $('.cursor');
        playBack.cursorLine = $('.cursor .line');
        
        // if (!circleLayer.isAnimated())
        //     circleLayer.setAnimate(true);
        //     setTimeout(function(){
        //         if(!playBack.playing){
        //             circleLayer.setAnimate(false);
        //         }
        //     }, 1500);
        updateHoverBox();
        playBack.timeline.setDate(refugees.currentDate);
        playBack.timeline.startAnimation();
      }

//       function testAllPaths(){
//           var data = [];
//           for(var or_key in refugees.paths){
//               for(var asyl_key in refugees.paths[or_key]){
//                   var path = refugees.paths[or_key][asyl_key]["path"];
//                   data.push(or_key, asyl_key, path);
//               }
//           }
//           delayExecute(data, 0);
//       }
        
//       function delayExecute(data, i){
//           setTimeout(function(){
//               console.log(data[i], data[i+1]);
//               refugees.particles.addParticle(data[i+2]);
//               console.log("done.");
//               var j = i+3;
//               if(j < data.length){
//                   delayExecute(data, j);
//               }
//           }, 3000);
//       }

      function togglePlayPause(){
        playBack.playing = !playBack.playing;
         $('#circle').children().toggleClass('play').toggleClass('pause');
        if(playBack.playing){
          play();
        }else{
          pause();
        }
      }

      function incrementMonth(){
        var $valid = $('.valid');
        var currentCursorIndex = playBack.cursor.index('.valid');
        if(currentCursorIndex < 0 || currentCursorIndex + 1 == $valid.length){
          $valid.removeClass('cursor');
          $valid.eq(0).addClass('cursor');
        }else{
          $valid.removeClass('cursor');
          $valid.eq(currentCursorIndex+1).addClass('cursor');
        }
        upDate();
      }
        
      function decrementMonth(){
        var currentCursorIndex = $('.cursor').index('.valid');
        if(currentCursorIndex < 0 || currentCursorIndex == 0){
          $('.valid').removeClass('cursor');
          $('.valid').eq($('.valid').length - 1).addClass('cursor');
        }else{
          $('.valid').removeClass('cursor');
          $('.valid').eq(currentCursorIndex-1).addClass('cursor');
        }
        upDate();
      }


      function play(){
          // circleLayer.setAnimate(true);
          playBack.timeline.playing = true;
          playBack.timeline.startAnimation();
      }

      function pause(){
        playBack.timeline.playing = false;
        // setTimeout(function(){
        //       circleLayer.setAnimate(false);
        //   }, 1500);
      }
    
      function updatePath(){
          path_geo = refugees.geo_data.path_geo;
          for(var or_key in path_geo){
              for(var asyl_key in path_geo[or_key]){
                  path_array = path_geo[or_key][asyl_key];
                  for(var i = 0; i < path_array.length; i++){
                      refugees.paths[or_key][asyl_key]["points"][i] = map.getProjection().fromLatLngToPoint(path_array[i]);
                  }
                  refugees.paths[or_key][asyl_key]["path"] = getPathThroughPoints(refugees.paths[or_key][asyl_key]["points"]);
              }
          }
      }
      
      Number.prototype.clamp = function(min, max) {
         return Math.min(Math.max(this, min), max);
      };
      
      function convert_to_radius(amount){
          amount = amount.clamp(0, drawBack.MAX_AMOUNT)
          return .035*Math.sqrt(amount);
      }
        
      String.prototype.format = function () {
          var args = [].slice.call(arguments);
              return this.replace(/(\{\d+\})/g, function (a){
                  return args[+(a.substr(1,a.length-2))||0];
              });
        };
        
      function convert_to_color(amount){
          var color = (amount > 0) ? 
              {r: 50, g:150, b:50} : {r: 150, g:50, b:50};
           if(amount == 0){
              color = {r: 80, g:80, b:80}
            }
          return "rgba({0},{1},{2}, {3})".format(color.r, color.g, color.b, .3);
      }
        
      function drawPath(path, data){
        //Drawing path
        makePath(circleContext, path);
        circleContext.lineWidth = .35;
        circleContext.strokeStyle = convert_to_color(data);
        circleContext.lineCap = "round";
        circleContext.stroke();
      }
        
      function canvasResize(){
      }
        
      function glResize(){
        console.log('resizeHandler');
        var w = gl.canvas.width;
        var h = gl.canvas.height;
        gl.viewport(0, 0, w, h);

        // matrix which maps pixel coordinates to WebGL coordinates
        pixelsToWebGLMatrix.set([2/w, 0,   0, 0,
          0,  -2/h, 0, 0,
          0,   0,   0, 0,
         -1,   1,   0, 1]);
      }
        
      function translateMatrix(matrix, tx, ty) {
        matrix[12] += matrix[0]*tx + matrix[4]*ty;
        matrix[13] += matrix[1]*tx + matrix[5]*ty;
        matrix[14] += matrix[2]*tx + matrix[6]*ty;
        matrix[15] += matrix[3]*tx + matrix[7]*ty;
      }
        
      function scaleMatrix(matrix, scaleX, scaleY) {
        matrix[0] *= scaleX;
        matrix[1] *= scaleX;
        matrix[2] *= scaleX;
        matrix[3] *= scaleX;

        matrix[4] *= scaleY;
        matrix[5] *= scaleY;
        matrix[6] *= scaleY;
        matrix[7] *= scaleY;
      }
        
       function draw(transform) {
        if (refugees.ready) {

          gl.useProgram(program);

          var pointSize = 4 * Math.pow(20 / 4, (map.zoom - 3) / (10 - 3));
          var sizeLoc = gl.getUniformLocation(program, 'uSize');
          gl.uniform1f(sizeLoc, pointSize);

          var matrixLoc = gl.getUniformLocation(program, 'uMapMatrix');
          gl.uniformMatrix4fv(matrixLoc, false, transform);

          var epochLoc = gl.getUniformLocation(program, 'uEpoch');
          gl.uniform1f(epochLoc, playBack.timeline.currentTime);

          // var spanLoc = gl.getUniformLocation(program, 'uSpan');
          // gl.uniform1f(spanLoc, playBack.timeline.span);

          gl.bindBuffer(gl.ARRAY_BUFFER, refugees.arrayBuffer);

        var attributeLoc = gl.getAttribLocation(program, 'aStartPoint');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 2, gl.FLOAT, false, 32, 0);

        var attributeLoc = gl.getAttribLocation(program, 'aEndPoint');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 2, gl.FLOAT, false, 32, 8);

        var attributeLoc = gl.getAttribLocation(program, 'aMidPoint');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 2, gl.FLOAT, false, 32, 16);

        var attributeLoc = gl.getAttribLocation(program, 'aEpoch');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 1, gl.FLOAT, false, 32, 24);
        
        var attributeLoc = gl.getAttribLocation(program, 'aSpan');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 1, gl.FLOAT, false, 32, 28);

//         var attributeLoc = gl.getAttribLocation(program, 'aCoo');
//         gl.enableVertexAttribArray(attributeLoc);
//         gl.vertexAttribPointer(attributeLoc, 1, gl.FLOAT, false, 36, 28);

//         var attributeLoc = gl.getAttribLocation(program, 'aCor');
//         gl.enableVertexAttribArray(attributeLoc);
//         gl.vertexAttribPointer(attributeLoc, 1, gl.FLOAT, false, 36, 32);


//         var year = new Date(timeSlider.getCurrentTime()).getFullYear();

//         var count;
//         if (year < 2001) {
//           year = 2001;
//         }
//          if (year != 2013) {
//           count = refugees.pointIdx[year]['count'] + refugees.pointIdx[year+1]['count'];
//          } else {
//           count = refugees.pointIdx[year]['count'];

//          }
//           gl.drawArrays(gl.POINTS, refugees.pointIdx[year]['start'], count);
//           //gl.drawArrays(gl.POINTS, 0, refugees.pointCount);
//         }
          gl.drawArrays(gl.POINTS, 0, refugees.pointCount);
          }
           
       }
      function particleUpdate(){
          if(refugees.ready){
              gl.clear(gl.COLOR_BUFFER_BIT);
              var mapProjection = map.getProjection();
              mapMatrix.set(pixelsToWebGLMatrix);
              var scale = particleLayer.getMapScale();
              scaleMatrix(mapMatrix, scale, scale);
              var translation = particleLayer.getMapTranslation();
              translateMatrix(mapMatrix, translation.x, translation.y);
              draw(mapMatrix);
              playBack.timeline.animate();
          }
      }
        
      function circleUpdate() {
        var mapProjection = map.getProjection()
        var canvasWidth = circleLayer.canvas.width;
        var canvasHeight = circleLayer.canvas.height;
        circleContext.clearRect(0, 0, canvasWidth, canvasHeight);

        circleContext.setTransform(1, 0, 0, 1, 0, 0);
        var scale = (1 << map.zoom) * resolutionScale;
        circleContext.scale(scale, scale);
        var offset = mapProjection.fromLatLngToPoint(circleLayer.getTopLeft());
        circleContext.translate(-offset.x, -offset.y);
           
        //origins
        origin_geo = refugees.geo_data.origin_geo;
        asylum_geo = refugees.geo_data.asylum_geo;
        path_geo = refugees.geo_data.path_geo;
        circle_data = refugees.draw_data.raw;
        path_data = refugees.draw_data.derivative;
        var month = refugees.currentDate.month;
        var year = refugees.currentDate.year;
          
        //origin
        circleContext.lineWidth = drawBack.BASE_STROKE;
        for(var or_key in origin_geo){
            var radius = drawBack.BASE_RADIUS;
            var error = false;
            var originPoint = mapProjection.fromLatLngToPoint(origin_geo[or_key]);
            var currentAmount = 0;
            for(var asyl_country in circle_data){
                var asylumPoint = mapProjection.fromLatLngToPoint(asylum_geo[asyl_country]);
                if(month in circle_data[asyl_country][year] 
                   && or_key in circle_data[asyl_country][year][month]){
                    currentAmount = circle_data[asyl_country][year][month][or_key] || 0;
                    var prevAmount = refugees.prev_shown["origin"][or_key];
                    
                    var interpolated_raw = (currentAmount == prevAmount) ? 
                        currentAmount : prevAmount + Math.ceil((currentAmount - prevAmount)/drawBack.origin_interpolate);
                    radius += convert_to_radius(interpolated_raw);
                    refugees.prev_shown["origin"][or_key] = interpolated_raw;
                    //try{
                        // var pointData = path_geo[or_key][asyl_country];
                        // var path = refugees.paths[or_key][asyl_country]["path"];
                        // drawPath(path, 
                        //          path_data[asyl_country][year][month][or_key]);
                    //}catch(error){
                        //console.log("No path between {0} and {1}".format(or_key, asyl_country), error);
                    //}
                }else if(!(month in circle_data[asyl_country][year])){
                    radius = .25;
                    error = true;
                } 
            }
            radius = (radius < 0) ? .1 : radius;
  
            if(!error){
                circleContext.fillStyle = 'rgba(68,153,215, .3)';
                circleContext.strokeStyle = 'rgb(68,153,215)';
            }else{
                circleContext.fillStyle = 'rgba(180, 180, 180, .3)';
                circleContext.strokeStyle = 'rgb(180, 180, 180)';
            }
             //draws circle at origin country
            circleContext.beginPath();
            circleContext.arc(originPoint.x, originPoint.y,radius, 0, 2 * Math.PI, false);
            circleContext.fill();
            circleContext.lineWidth = drawBack.BASE_STROKE;
            circleContext.stroke();
        }
          
        //asylum
          
        circleContext.fillStyle = 'rgba(215, 68, 115, .3)';
        circleContext.strokeStyle = 'rgb(215, 68, 115)';
        for(var asyl_country in circle_data){
            var radius = drawBack.BASE_RADIUS;
            origin_countries = circle_data[asyl_country][year][month]
            var total = 0;
            for (var country in origin_countries){
                total += (origin_countries[country] || 0)
            }
            var prevTotal = refugees.prev_shown["asylum"][asyl_country];
            var interpolated_raw = (total == prevTotal) ? 
                        total : prevTotal + Math.ceil((total - prevTotal)/drawBack.asylum_interpolate);
            refugees.prev_shown["asylum"][asyl_country] = interpolated_raw;
            radius += convert_to_radius(interpolated_raw);
            radius = (radius < 0) ? .1 : radius;
            var asylumPoint = mapProjection.fromLatLngToPoint(asylum_geo[asyl_country]);
            circleContext.beginPath();
            circleContext.arc(asylumPoint.x, asylumPoint.y,radius, 0, 2 * Math.PI, false);
            
            circleContext.fill();
            circleContext.stroke();
        } 
          
        //deaths
        var currentAmount = refugees.deaths[year][month] || 0;
        var prevAmount = refugees.prev_shown["deaths"];

        var interpolated_raw = (currentAmount == prevAmount) ? 
            currentAmount : prevAmount + Math.ceil((currentAmount - prevAmount)/drawBack.origin_interpolate);
        refugees.prev_shown["deaths"] = interpolated_raw;
        var deathsPoint = mapProjection.fromLatLngToPoint(refugees.deaths.location);
        var radius = convert_to_radius(interpolated_raw);
        circleContext.beginPath();
        circleContext.arc(deathsPoint.x, deathsPoint.y,radius, 0, 2 * Math.PI, false);
        circleContext.fillStyle = 'rgba(255, 255, 255, .3)';
        circleContext.fill();
        circleContext.strokeStyle = 'rgb(255, 255, 255)';
        circleContext.stroke();
      }
      
      function getClosestElement(testPoint, threshold){
          var closest = {name:"None Found", type:"", latlon: null};
          var closestDist = Number.MAX_VALUE;
          for(var asyl_key in refugees.geo_data.asylum_geo){
              var latlon = refugees.geo_data.asylum_geo[asyl_key];
              var dist = getDistance(latlon, testPoint);
              if(dist < threshold){
                  return {name:asyl_key, type:"asylum", latlon:latlon};
              }
          }
          for(var or_key in refugees.geo_data.origin_geo){
              var latlon = refugees.geo_data.origin_geo[or_key];
              var dist = getDistance(latlon, testPoint);
              if(dist < threshold){
                  closestDist = dist;
                  return {name:or_key, type:"origin", latlon:latlon};
              }
          }
          
          var latlon = refugees.deaths.location;
          var dist = getDistance(latlon, testPoint);
          
          if(dist < threshold){
              return {name:"deaths", type:"deaths", latlon:latlon};
          }
          
          return {name:"None Found", data:{}, latlon: null};
      }
      
      function processMapHover(event){
          var closest = getClosestElement(event.latLng, 75000);
          drawBack.lasthover = drawBack.hover
          if(closest.latlon != null){
              if(drawBack.hover == {} || drawBack.hover.name != closest.name){
                  drawBack.hover = closest;
              }
          }else{
              drawBack.hover = {};
          }
          updateHoverBox();
      }
      //from https://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
      function numberWithCommas(x) {
          return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
        
      function updateHoverBox(){
          var hoverHTML = [];
          hoverHTML.push('<div id="hoverbox">');
          if(!$.isEmptyObject(drawBack.hover)){
              var year = refugees.currentDate.year || 2014;
              var month = refugees.currentDate.month || 1;

              var name = drawBack.hover.name;
              switch(drawBack.hover.type){
                  case "asylum":
                      hoverHTML.push('<p><strong>',name,':</strong> asylum country</p>');
                      var total = 0
                      var data = refugees.draw_data.raw[name][year][month];
                      for(var or_key in data){
                          var amount = data[or_key];
                          hoverHTML.push('<p>From <strong>',or_key,'</strong>: ',numberWithCommas(amount),'</p>');
                          total += amount;
                      }
                      hoverHTML.push('<p>Total: ',numberWithCommas(total),'</p>');
                      break;
                  case "origin":
                      hoverHTML.push('<p><strong>',name,':</strong> origin country</p>');
                      var total = 0;
                      for(var asyl_key in refugees.draw_data.raw){
                          var data = refugees.draw_data.raw[asyl_key][year][month];
                          if(name in data){
                              var amount = data[name];
                              hoverHTML.push('<p>To <strong>',asyl_key,'</strong>: ',numberWithCommas(amount),'</p>');
                              total += amount;
                          }  
                      }
                      hoverHTML.push('<p>Total: ',numberWithCommas(total),'</p>');
                      break;
                  case "deaths":
                      hoverHTML.push('<p>Deaths: ',numberWithCommas(refugees.deaths[year][month]),'</p>');
                      break;
                  default:
                      console.log(drawBack.hover);
              }
          }else{
              if(drawBack.infowindow){
                  drawBack.infowindow.close()
              }
              drawBack.infowindow = null;
              return;
          }
          var dateString = '';
          switch(month){
              case 1: 
                  dateString = "January ";
                  break;
              case 2:
                  dateString = "February ";
                  break;
              case 3:
                  dateString = "March ";
                  break;
              case 4:
                  dateString = "April ";
                  break;
              case 5:
                  dateString = "May ";
                  break;
              case 6:
                  dateString = "June ";
                  break;
              case 7:
                  dateString = "July ";
                  break;
              case 8:
                  dateString = "August ";
                  break;
              case 9:
                  dateString = "September ";
                  break;
              case 10:
                  dateString = "October ";
                  break;
              case 11:
                  dateString = "November ";
                  break;
              case 12:
                  dateString = "December ";
                  break;
          }
          hoverHTML.push('<p>',dateString,year,'</p>')
          hoverHTML.push('</div>');
          if(drawBack.infowindow){
              drawBack.infowindow.setContent(hoverHTML.join(''));
          }else{
              drawBack.infowindow = new google.maps.InfoWindow({
                  content: hoverHTML.join(''),
                  position: drawBack.hover.latlon
              });
              drawBack.infowindow.open(map);
          }
      }
        
      function initMap(){
        // initialize the map
        var mapOptions = {
          zoom: 4,
          minZoom: 3,
          center: new google.maps.LatLng(34.17497, 22.09833),
          mapTypeId: google.maps.MapTypeId.TERRAIN,
          keyboardShortcuts: false,
          styles: [
                {
                    "featureType": "all",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "saturation": 36
                        },
                        {
                            "color": "#999999"
                        },
                        {
                            "lightness": 40
                        }
                    ]
                },
                {
                    "featureType": "all",
                    "elementType": "labels.text.stroke",
                    "stylers": [
                        {
                            "visibility": "on"
                        },
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 16
                        }
                    ]
                },
                {
                    "featureType": "all",
                    "elementType": "labels.icon",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "featureType": "administrative",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 15
                        }
                    ]
                },
                {
                    "featureType": "administrative",
                    "elementType": "geometry.stroke",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 17
                        },
                        {
                            "weight": 1.2
                        }
                    ]
                },
                {
                    "featureType": "landscape",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 15
                        }
                    ]
                },
                {
                    "featureType": "poi",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 16
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 17
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry.stroke",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 29
                        },
                        {
                            "weight": 0.2
                        }
                    ]
                },
                {
                    "featureType": "road.arterial",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 18
                        }
                    ]
                },
                {
                    "featureType": "road.local",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 16
                        }
                    ]
                },
                {
                    "featureType": "transit",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 19
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color":"#0b2929"
                        },
                        {
                            "lightness": 17
                        }
                    ]
                }
            ]
        };
        var mapDiv = document.getElementById('map-div');
        return new google.maps.Map(mapDiv, mapOptions);
      }
        
      function initCanvasLayer(updateHandler, animated, resize){
        // initialize the canvasLayer
        var canvasLayerOptions = {
          map: map,
          resizeHandler: resize,
          animate: animated,
          updateHandler: updateHandler,
          resolutionScale: resolutionScale
        };
        return new CanvasLayer(canvasLayerOptions);
      }
        
      function load(url, responseType) {
        return new Promise(function(resolve, reject){
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            xhr.responseType = responseType;
            xhr.onload = function() {
              if(xhr.status == 200){
                  resolve(this.response);
              }else{
                  reject(Error(xhr.statusText));
              }
            };
            // Handle network errors
            xhr.onerror = function() {
              reject(Error("Network Error"));
            };

            xhr.send();
        }); 
      }
        
      function geo_handler(json_data){
          prev_shown_origin = {};
          prev_shown_asylum = {};
          for(var key in json_data.origin_geo){
              var lat_long = json_data.origin_geo[key];
              json_data.origin_geo[key] = new google.maps.LatLng(lat_long.lat, lat_long.lon);
              prev_shown_origin[key] = 0;
          }
          
          for(var key in json_data.asylum_geo){
              var lat_long = json_data.asylum_geo[key];
              json_data.asylum_geo[key] = new google.maps.LatLng(lat_long.lat, lat_long.lon);
              prev_shown_asylum[key] = 0;
          }
          
          var paths = {};
          
          for(var or_key in json_data.path_geo){
              paths[or_key] = {};
              var or_data = json_data.path_geo[or_key];
              for (var asyl_key in or_data){
                  paths[or_key][asyl_key] = {};
                  paths[or_key][asyl_key]["points"] = [];
                  paths[or_key][asyl_key]["path"] = null;
                  path_array = or_data[asyl_key];
                  for(var i = 0; i < path_array.length; i++){
                      var googleLatLong = new google.maps.LatLng(path_array[i].lat, path_array[i].lon);
                      json_data.path_geo[or_key][asyl_key][i] = googleLatLong;
                      paths[or_key][asyl_key]["points"].push(null);
                  }
              }
          }
          
          refugees.geo_data = json_data;
          refugees.prev_shown.origin = prev_shown_origin;
          refugees.prev_shown.asylum = prev_shown_asylum;
          refugees.paths = paths;
          console.log(refugees.geo_data, refugees.paths);
      }
        
      function circles_handler(json_data){ 
          refugees.deaths = json_data["deaths"];
          refugees.deaths = $.extend(true, {}, json_data)["deaths"];
          refugees.prev_shown["deaths"] = 0;
          refugees.deaths["location"] = new google.maps.LatLng(39.639537564366684,4.21875);
          delete json_data["deaths"]
          var dx_data = $.extend(true, {}, json_data);
          for(var asyl_country in json_data){
              var years_data = json_data[asyl_country];
              for (var year in years_data){
                  if(!(year in refugees.largestValue)){
                      refugees.largestValue[year] = {};
                  }
                  var year_data = years_data[year];
                  for (var month in year_data){
                      if(!(month in refugees.largestValue[year])){
                          refugees.largestValue[year][month] = 0;
                      }
                      $('#m'+month+'y'+year).addClass('valid');
                      var origin_countries = year_data[month];
                      var total = 0;
                      for(var or_key in origin_countries){
                          var currentVal = json_data[asyl_country][year][month][or_key];
                          if(month != 1 || year != 2014){
                              var prevVal = (month == 1) ? 
                                  json_data[asyl_country][year-1][12][or_key] : dx_data[asyl_country][year][month-1][or_key]
                              dx_data[asyl_country][year][month][or_key] = currentVal - prevVal;
                          }
                          total += currentVal;
                          currentLargest = refugees.largestValue[year][month];
                          refugees.largestValue[year][month] = (currentVal > currentLargest) ? currentVal : currentLargest;
                      }
                  }
              }
          }
          
          var largestOfAll = 0;
          for(var year in refugees.largestValue){
              for (var month in refugees.largestValue[year]){
                  var value = refugees.largestValue[year][month];
                  largestOfAll = (value > largestOfAll) ? value : largestOfAll;
              }
          }
          
          refugees.largestValue["largestOfAll"] = largestOfAll;
          refugees.draw_data.raw = json_data;
          refugees.draw_data.derivative = dx_data;
          console.log(refugees.draw_data, refugees.deaths);
      }  
        
      function setData(buffer) {
        refugees.pointCount = buffer.length / 8;
        refugees.data = buffer;
        refugees.arrayBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, refugees.arrayBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, refugees.data, gl.STATIC_DRAW);

        var attributeLoc = gl.getAttribLocation(program, 'aStartPoint');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 2, gl.FLOAT, false, 32, 0);

        var attributeLoc = gl.getAttribLocation(program, 'aEndPoint');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 2, gl.FLOAT, false, 32, 8);

        var attributeLoc = gl.getAttribLocation(program, 'aMidPoint');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 2, gl.FLOAT, false, 32, 16);

        var attributeLoc = gl.getAttribLocation(program, 'aEpoch');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 1, gl.FLOAT, false, 32, 24);
        
        var attributeLoc = gl.getAttribLocation(program, 'aSpan');
        gl.enableVertexAttribArray(attributeLoc);
        gl.vertexAttribPointer(attributeLoc, 1, gl.FLOAT, false, 32, 28);

//         var attributeLoc = gl.getAttribLocation(program, 'aCoo');
//         gl.enableVertexAttribArray(attributeLoc);
//         gl.vertexAttribPointer(attributeLoc, 1, gl.FLOAT, false, 36, 28);

//         var attributeLoc = gl.getAttribLocation(program, 'aCor');
//         gl.enableVertexAttribArray(attributeLoc);
//         gl.vertexAttribPointer(attributeLoc, 1, gl.FLOAT, false, 36, 32);

        refugees.ready = true;
      }
        
      function particle_handler(array_buffer){
          setData(new Float32Array(array_buffer));
      }
      
      function init() {
        Promise.all([load(refugees.geo_url, 'json'), 
                     load(refugees.draw_url, 'json'),//]) 
                     load(refugees.particle_url, 'arraybuffer')])
        .then(function(response){
           map = initMap();
           console.log("promise finished");
           geo_handler(response[0]);
           circles_handler(response[1]);
           google.maps.event.addListenerOnce(map, 'idle', function(){
                updatePath();

//                 circleLayer = initCanvasLayer(circleUpdate, false, canvasResize);
//                 circleContext = circleLayer.canvas.getContext('2d');

                particleLayer = initCanvasLayer(particleUpdate, true, glResize);
                gl = particleLayer.canvas.getContext('experimental-webgl');
                gl.enable(gl.BLEND);
                gl.blendFunc( gl.SRC_ALPHA, gl.ONE );
                glb = new Glb(gl);
                program = glb.programFromSources(document.getElementById('point-vertex-shader').text,
                                     document.getElementById('point-fragment-shader').text); 
                particle_handler(response[2]);
                var el = document.getElementById("loading");
                el.style['display'] = 'none';
                refugees.currentDate = new Date_M_Y(1,2014);
                $('#m1y2014').addClass('cursor');
                upDate();
            });
            google.maps.event.addListener(map, 'mousemove', processMapHover);
        }).catch(function(err){
            console.log("Error: " + err);
        });
          
        $('#circle').click(togglePlayPause);
        $('.year').on("mousedown", ".valid", function(event){
                playBack.mouseDown = true;
                $('.valid').removeClass('cursor');
                $(this).addClass('cursor');
                upDate();
        })
        .on("mousemove", ".valid", function(event){
          if(playBack.mouseDown){
            $('.valid').removeClass('cursor');
            $(this).addClass('cursor');
            upDate();
          }
        })
        .on("mouseup", ".valid", function(){
              playBack.mouseDown = false;
        })
        .addClass('noselect');


        $('.year').addClass('noselect');

        $('document').on("mouseup", function(){
              playBack.mouseDown = false;
        });
          
        $('body').keyup(function(e){
           if(e.keyCode == 32){
               // space bar
               togglePlayPause();
           }else if(e.keyCode == 37){
               //left arrow
               decrementMonth();
           }else if(e.keyCode == 39){
               //right arrow
               incrementMonth();
           }
        });
      }
        
      document.addEventListener('DOMContentLoaded', init, false);
      window.addEventListener('resize', function () {  google.maps.event.trigger(map, 'resize') }, false);
    </script>
  </head>
  <body>
    <div id="map-div"></div>
    <div id="time-slider">
        <div id="play-button">
          <div id="circle">
            <div class="play"></div>
          </div>
        </div>
        <div class="year" id="y2014" data-year="2014" style="border-top: 6px solid rgb(68, 215, 168); background-color:rgba(68, 215, 168, .5)">
            <div class="month" id="m1y2014" data-month="1"><div class="line"></div><p>Jan</p></div>
            <div class="month" id="m2y2014" data-month="2"><div class="line"></div><p>Feb</p></div>
            <div class="month" id="m3y2014" data-month="3"><div class="line"></div><p>Mar</p></div>
            <div class="month" id="m4y2014" data-month="4"><div class="line"></div><p>Apr</p></div>
            <div class="month" id="m5y2014" data-month="5"><div class="line"></div><p>May</p></div>
            <div class="month" id="m6y2014" data-month="6"><div class="line"></div><p>Jun</p></div>
            <div class="month" id="m7y2014" data-month="7"><div class="line"></div><p>Jul</p></div>
            <div class="month" id="m8y2014" data-month="8"><div class="line"></div><p>Aug</p></div>
            <div class="month" id="m9y2014" data-month="9"><div class="line"></div><p>Sep</p></div>
            <div class="month" id="m10y2014" data-month="10"><div class="line"></div><p>Oct</p></div>
            <div class="month" id="m11y2014" data-month="11"><div class="line"></div><p>Nov</p></div>
            <div class="month" id="m12y2014" data-month="12"><div class="line"></div><p>Dec</p></div>
            <p>2014</p>
        </div>
        <div class="year" id="y2015" data-year="2015" style="border-top: 6px solid rgb(68, 118, 215); background-color:rgba(68, 189, 215, .5)">
            <div class="month" id="m1y2015" data-month="1"><div class="line"></div><p>Jan</p></div>
            <div class="month" id="m2y2015" data-month="2"><div class="line"></div><p>Feb</p></div>
            <div class="month" id="m3y2015" data-month="3"><div class="line"></div><p>Mar</p></div>
            <div class="month" id="m4y2015" data-month="4"><div class="line"></div><p>Apr</p></div>
            <div class="month" id="m5y2015" data-month="5"><div class="line"></div><p>May</p></div>
            <div class="month" id="m6y2015" data-month="6"><div class="line"></div><p>Jun</p></div>
            <div class="month" id="m7y2015" data-month="7"><div class="line"></div><p>Jul</p></div>
            <div class="month" id="m8y2015" data-month="8"><div class="line"></div><p>Aug</p></div>
            <div class="month" id="m9y2015" data-month="9"><div class="line"></div><p>Sep</p></div>
            <div class="month" id="m10y2015" data-month="10"><div class="line"></div><p>Oct</p></div>
            <div class="month" id="m11y2015" data-month="11"><div class="line"></div><p>Nov</p></div>
            <div class="month" id="m12y2015" data-month="12"><div class="line"></div><p>Dec</p></div>
            <p>2015</p>
        </div>
        <div class="year" id="y2016" data-year="2016" style="border-top: 6px solid rgb(215, 68, 115); background-color:rgba(215, 68, 115, .5)">
            <div class="month" id="m1y2016" data-month="1"><div class="line"></div><p>Jan</p></div>
            <div class="month" id="m2y2016" data-month="2"><div class="line"></div><p>Feb</p></div>
            <div class="month" id="m3y2016" data-month="3"><div class="line"></div><p>Mar</p></div>
            <div class="month" id="m4y2016" data-month="4"><div class="line"></div><p>Apr</p></div>
            <div class="month" id="m5y2016" data-month="5"><div class="line"></div><p>May</p></div>
            <div class="month" id="m6y2016" data-month="6"><div class="line"></div><p>Jun</p></div>
            <div class="month" id="m7y2016" data-month="7"><div class="line"></div><p>Jul</p></div>
            <div class="month" id="m8y2016" data-month="8"><div class="line"></div><p>Aug</p></div>
            <div class="month" id="m9y2016" data-month="9"><div class="line"></div><p>Sep</p></div>
            <div class="month" id="m10y2016" data-month="10"><div class="line"></div><p>Oct</p></div>
            <div class="month" id="m11y2016" data-month="11"><div class="line"></div><p>Nov</p></div>
            <div class="month" id="m12y2016" data-month="12"><div class="line"></div><p>Dec</p></div>
            <p>2016</p>
        </div>
      </div>
      <div id="loading"></div>
  </body>
</html>