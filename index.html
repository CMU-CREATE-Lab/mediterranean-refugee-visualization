<!doctype html>
<html>
  <head>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <title>Refugees by Mediterranean Sea</title>
    <style type="text/css">
        html, body, #map-div {
              margin: 0;
              padding: 0;
              height: 100%;
              font-family: monospace;
        }

        .noselect {
          -webkit-touch-callout: none; /* iOS Safari */
          -webkit-user-select: none;   /* Chrome/Safari/Opera */
          -khtml-user-select: none;    /* Konqueror */
          -moz-user-select: none;      /* Firefox */
          -ms-user-select: none;       /* Internet Explorer/Edge */
          user-select: none;           /* Non-prefixed version, currently
                                          not supported by any browser */
        }
        
        #map-div{
            position: absolute; 
            top: 0px; 
            width: 100%; 
            height: calc(100% - 55px);
        }
        
        #time-slider{
            position: absolute;  
            bottom: 0px; 
            width: 100%; 
            height: 56px; 
            background-color: rgb(30,30,30);
        }

        .cursor{
          background-color: rgb(160,160,160) !important;
        }
        
        .trapezoid {
          border-bottom: 25px solid rgba(255,10,10,.5);
          border-left: 15px solid transparent;
          border-right: 15px solid transparent;
          height: 0;
          width: 7px;
          transform: scaleY(-1) translateY(-6px);
        }

        .bar{
          margin-left: 15px;
          width: 7px;
          height: 45%;
          background-color: rgba(255,10,10,.5);
          transform: translateY(23%);
        }
        
        #play-button{
            position: relative;
            float: left;
            width: 50px;
            height: 50px;
            background-color: rgb(30,30,30);
            border-bottom: 5px rgb(30,30,30);
        }

        #circle{
            position: absolute;
            width: 70%;
            height: 70%;
            -moz-border-radius: 50px/50px;
            -webkit-border-radius: 50px 50px;
            border-radius: 50px/50px;
            border:solid 2px rgb(130,130,130);
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: background-color .3s;
        }

        #circle:hover{
            background-color: rgb(100,100,100);
            cursor: pointer;
        }

        #circle:hover > .play{
          border-left: 12px solid rgb(30,30,30);
        }

        #circle:hover > .pause{
          background-color: rgb(30,30,30);
        }

        .play{
            position: absolute;
            width: 0; 
            height: 0; 
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            border-left: 12px solid rgb(130,130,130);
            top: 50%;
            left: 54%;
            transform: translate(-50%, -50%);
        }

        .pause{
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: rgb(130,130,130);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid black;
        }
        
        .year{
            position: relative;
            float: left;
            width: calc((100% - 50px)/3);
            height: 50px;
            /**background-color: blue;**/
            text-align: center;
        }
        
        .year > p{
            position: relative; 
            margin-top: 30px; 
            text-align: center;
            font-size: 13px;
            color: white;
        }
        
        .month{
            position: relative;
            height: 50%;
            width: calc(100%/12);
            background-color: rgb(20,20,20);
            float: left;
            transition: background-color .3s;
        }
        
        .valid{
            background-color: rgb(60,60,60);
        }
        
        .valid:hover{
            background-color: rgb(100,100,100);
            cursor: pointer;
        }
        
        .month > p{
            font-size: 11px;
            margin-top: 4px;
            color: white;
        }
        
        .line {
/*             transition: left 10ms; */
        }
        
        .cursor > .line {
            display: block;
            background-color: red;
            width: 2px;
            height: 100%;
            position: absolute;
            top: 0px;
            z-index: 10;
        }
        
        .line {
            display: none;
        }
        
        
        #loading {
          background: url(images/loading.gif) no-repeat center;
          pointer-events: none;
          position: absolute;
          height: 50px;
          width: 50px;
          z-index: 100;
          top: 50%;
          left: 50%;

        }
    </style>

    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDC5znDfzJNHdK_Bc9jTPIVS4BUZhYeOAA"></script>
    <script type="text/javascript" src="js/CanvasLayer.js"></script>
    <script type="text/javascript" src="js/quadraticBezier.js"></script>
    <script type="text/javascript" src="js/LatLon.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script type="text/javascript" src="js/chroma.js"></script>

    <script type="text/javascript">
      var map;
      var circleLayer;
      var particleLayer;
      var circleContext;
      var particleContext;
      
      var refugees = {
        geo_url: './geo_data/geo_data.json',
        draw_url: './json_store/processed_data.json',
        deaths_url: './json_store/death.json',
        ready: true,
        geo_data: {},
        draw_data: {},
        prev_shown: {},
        paths: {},
        deaths: {},
        particles: new ParticleManager(),
        largestValue: {},
        largestOfAll: 0
      };
        
      var playBack = {
          playing: false,
          player: null,
          mouseDown: false
      }
      
      var drawBack = {
          MAX_RADIUS: 3,
          BASE_RADIUS: .25,
          BASE_STROKE: .15,
          MAX_AMOUNT: 30000,
          origin_interpolate: 25,
          asylum_interpolate: 10,
          particle_size: .15,
          hover: {},
          cursor: null,
          lasthover: null,
          infowindow: null,
          colors: (function(){
              colors = [];
              color = chroma('aquamarine');
              for(var i = .1; i < .85; i+= .01){
                  colors.push(color.luminance(i, 'hsl').css());
              }
              for(var i = .85; i > .1; i-= .01){
                  colors.push(color.luminance(i, 'hsl').css());
              }
              return colors;
          })()
      }

      var resolutionScale = window.devicePixelRatio || 1;
        
      function Date_M_Y(month, year){
          this.month = month;
          this.year = year;
      }
              
      function Particle(path, radius, color){
          this.path = path;
          this.radius = radius || drawBack.particle_size;
          this.color = color || drawBack.colors[0];
          this.percent = 0;
          this.draw = function(){
              var currentPoint = this.path.getPointAtPercentage(this.percent);
              particleContext.fillStyle = this.color;
              particleContext.fillRect(currentPoint.x, currentPoint.y,radius, radius);
          };
          this.incrementPercent = function(){
              this.percent = (this.percent > 100) ? 100 : this.percent + 1;
          };
          this.isComplete = function(){
              return (this.percent >= 100);
          };
      }
      function ParticleSet(particle, amount){
          this.particle = particle;
          this.particles = (()=>{
              var particles = [];
              var i = amount;
              var colorIndex = 0;
              while(i--){
                  particles.push(new Particle(this.particle.path, this.particle.radius, drawBack.colors[colorIndex]));
                  colorIndex = (colorIndex >= drawBack.colors.length-1) ? 0 : colorIndex + 1;
              }
              return particles;
          })();
          this.ejectParticle = function(){
              return this.particles.pop();
          }
          this.isComplete = function(){
              return !this.particles.length;
          }
      }
        
      function ParticleManager(){
          this.particles = [];
          this.particleSets = [];
          this.clock = false;
          this.iterations = 0;
          this.maxIterations = 0;
          this.addParticle = function(particle){
              this.particles.push(particle);
          };
          this.addParticleSet = function(particleSet){
              this.particleSets.push(particleSet)
          };
          this.clearParticleArr = function(){
              this.particles = [];
          };
          this.clearParticleSets = function(){
              this.particleSets = [];
          };
          this.injectParticles = function(){
              var i = this.particleSets.length;
              while(i--){
                  var set = this.particleSets[i];
                  if(set.isComplete()){
                      this.particleSets.splice(i,1);
                  }else{
                      this.addParticle(set.ejectParticle());
                  }
              }
          };
          this.updateClock = function(){
              var iterations = refugees.particles.iterations;
              if(iterations > this.maxIterations){
                  refugees.particles.clearClock();
              }else{
                  refugees.particles.injectParticles();
                  refugees.particles.iterations = iterations + 1;
              }
              refugees.particles.setCursorLine();
          }
          this.clearClock = function(){
              this.iterations = 0;
              this.clock = false;
          };
          this.setClock = function(maxIterations){
              particleLayer.setAnimate(true);
              this.maxIterations = maxIterations;
              this.clock = true;
          };
          this.setCursorLine = function(){
              drawBack.cursor.style.left =
                  (this.iterations/this.maxIterations * 100)+"%";
          };
          this.draw = function(){
              var i = this.particles.length;
              while(i--){
                  var particle = this.particles[i];
                  if(particle.isComplete()){
                      this.particles.splice(i,1);
                  }else{
                      particle.incrementPercent();
                      particle.draw(particleContext);
                  }
              }
              particleLayer.setAnimate(this.particles.length || this.particleSets.length);

          };
      }
          
      function calculateRadius(amount){
          return drawBack.particle_size;
      }
          
      function processParticles(){
          refugees.particles.clearParticleSets();
          var raw_data = refugees.draw_data.raw;
          for(var asyl_key in raw_data){
              var or_data = raw_data[asyl_key][refugees.currentDate.year][refugees.currentDate.month];
              for(var or_key in or_data){
                  var amount = or_data[or_key];
                  if(amount>0){
                      try{
                          refugees.particles.addParticleSet(
                              new ParticleSet(
                                  new Particle(refugees.paths[or_key][asyl_key]["path"], 
                                               calculateRadius(amount)), 
                                  amount));
                      }catch(error){
                          console.log("No path between {0} and {1}".format(or_key, asyl_key));
                      }
                  }
              }
          }
          refugees.particles.clearClock();
          refugees.particles.setClock(refugees.largestValue[refugees.currentDate.year][refugees.currentDate.month]);
      }
    
      function upDate(){
        refugees.currentDate = new Date_M_Y($('.cursor').data('month'), $('.cursor').parent().data('year'));
        drawBack.cursor = document.getElementsByClassName("cursor")[0].getElementsByClassName("line")[0];
        processParticles()
        if (!circleLayer.isAnimated())
            circleLayer.setAnimate(true);
            setTimeout(function(){
                if(!playBack.playing){
                    circleLayer.setAnimate(false);
                }
            }, 1500);
        updateHoverBox();
      }

//       function testAllPaths(){
//           var data = [];
//           for(var or_key in refugees.paths){
//               for(var asyl_key in refugees.paths[or_key]){
//                   var path = refugees.paths[or_key][asyl_key]["path"];
//                   data.push(or_key, asyl_key, path);
//               }
//           }
//           delayExecute(data, 0);
//       }
        
//       function delayExecute(data, i){
//           setTimeout(function(){
//               console.log(data[i], data[i+1]);
//               refugees.particles.addParticle(data[i+2]);
//               console.log("done.");
//               var j = i+3;
//               if(j < data.length){
//                   delayExecute(data, j);
//               }
//           }, 3000);
//       }

      function togglePlayPause(){
        playBack.playing = !playBack.playing;
         $('#circle').children().toggleClass('play').toggleClass('pause');
        if(playBack.playing){
          play();
        }else{
          pause();
        }
      }

      function incrementMonth(){
        var currentCursorIndex = $('.cursor').index('.valid');
        if(currentCursorIndex < 0 || currentCursorIndex + 1 == $('.valid').length){
          $('.valid').removeClass('cursor');
          $('.valid').eq(0).addClass('cursor');
        }else{
          $('.valid').removeClass('cursor');
          $('.valid').eq(currentCursorIndex+1).addClass('cursor');
        }
        upDate();
      }
        
      function decrementMonth(){
        var currentCursorIndex = $('.cursor').index('.valid');
        if(currentCursorIndex < 0 || currentCursorIndex == 0){
          $('.valid').removeClass('cursor');
          $('.valid').eq($('.valid').length - 1).addClass('cursor');
        }else{
          $('.valid').removeClass('cursor');
          $('.valid').eq(currentCursorIndex-1).addClass('cursor');
        }
        upDate();
      }


      function play(){
          circleLayer.setAnimate(true);
          playBack.player = window.setInterval(incrementMonth, 1000);
      }

      function pause(){
        window.clearInterval(playBack.player);
        playBack.player = null;
        setTimeout(function(){
              circleLayer.setAnimate(false);
          }, 1500);
      }
        
      function load(url) {
        return new Promise(function(resolve, reject){
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            xhr.responseType = 'json';
            xhr.onload = function() {
              if(xhr.status == 200){
                  resolve(this.response);
              }else{
                  reject(Error(xhr.statusText));
              }
            };
            // Handle network errors
            xhr.onerror = function() {
              reject(Error("Network Error"));
            };

            xhr.send();
        }); 
      }
        
      function updatePath(){
          path_geo = refugees.geo_data.path_geo;
          for(var or_key in path_geo){
              for(var asyl_key in path_geo[or_key]){
                  path_array = path_geo[or_key][asyl_key];
                  for(var i = 0; i < path_array.length; i++){
                      refugees.paths[or_key][asyl_key]["points"][i] = map.getProjection().fromLatLngToPoint(path_array[i]);
                  }
                  refugees.paths[or_key][asyl_key]["path"] = getPathThroughPoints(refugees.paths[or_key][asyl_key]["points"]);
              }
          }
      }
        
      function geo_handler(json_data){
          prev_shown_origin = {};
          prev_shown_asylum = {};
          for(var key in json_data.origin_geo){
              var lat_long = json_data.origin_geo[key];
              json_data.origin_geo[key] = new google.maps.LatLng(lat_long.lat, lat_long.lon);
              prev_shown_origin[key] = 0;
          }
          
          for(var key in json_data.asylum_geo){
              var lat_long = json_data.asylum_geo[key];
              json_data.asylum_geo[key] = new google.maps.LatLng(lat_long.lat, lat_long.lon);
              prev_shown_asylum[key] = 0;
          }
          
          var paths = {};
          
          for(var or_key in json_data.path_geo){
              paths[or_key] = {};
              var or_data = json_data.path_geo[or_key];
              for (var asyl_key in or_data){
                  paths[or_key][asyl_key] = {};
                  paths[or_key][asyl_key]["points"] = [];
                  paths[or_key][asyl_key]["path"] = null;
                  path_array = or_data[asyl_key];
                  for(var i = 0; i < path_array.length; i++){
                      var googleLatLong = new google.maps.LatLng(path_array[i].lat, path_array[i].lon);
                      json_data.path_geo[or_key][asyl_key][i] = googleLatLong;
                      paths[or_key][asyl_key]["points"].push(null);
                  }
              }
          }
          
          refugees.geo_data = json_data;
          refugees.prev_shown.origin = prev_shown_origin;
          refugees.prev_shown.asylum = prev_shown_asylum;
          refugees.paths = paths;
          console.log(refugees.geo_data, refugees.paths);
      }
        
      function draw_handler(json_data){ 
          refugees.deaths = json_data["deaths"];
          refugees.deaths = $.extend(true, {}, json_data)["deaths"];
          refugees.prev_shown["deaths"] = 0;
          refugees.deaths["location"] = new google.maps.LatLng(39.639537564366684,4.21875);
          delete json_data["deaths"]
          var dx_data = $.extend(true, {}, json_data);
          for(var asyl_country in json_data){
              var years_data = json_data[asyl_country];
              for (var year in years_data){
                  if(!(year in refugees.largestValue)){
                      refugees.largestValue[year] = {};
                  }
                  var year_data = years_data[year];
                  for (var month in year_data){
                      if(!(month in refugees.largestValue[year])){
                          refugees.largestValue[year][month] = 0;
                      }
                      $('#m'+month+'y'+year).addClass('valid');
                      var origin_countries = year_data[month];
                      var total = 0;
                      for(var or_key in origin_countries){
                          var currentVal = json_data[asyl_country][year][month][or_key];
                          if(month != 1 || year != 2014){
                              var prevVal = (month == 1) ? 
                                  json_data[asyl_country][year-1][12][or_key] : dx_data[asyl_country][year][month-1][or_key]
                              dx_data[asyl_country][year][month][or_key] = currentVal - prevVal;
                          }
                          total += currentVal;
                          currentLargest = refugees.largestValue[year][month];
                          refugees.largestValue[year][month] = (currentVal > currentLargest) ? currentVal : currentLargest;
                      }
                  }
              }
          }
          
          var largestOfAll = 0;
          for(var year in refugees.largestValue){
              for (var month in refugees.largestValue[year]){
                  var value = refugees.largestValue[year][month];
                  largestOfAll = (value > largestOfAll) ? value : largestOfAll;
              }
          }
          
          refugees.largestValue["largestOfAll"] = largestOfAll;
          refugees.draw_data.raw = json_data;
          refugees.draw_data.derivative = dx_data;
          console.log(refugees.draw_data, refugees.deaths);
      }
      
      Number.prototype.clamp = function(min, max) {
         return Math.min(Math.max(this, min), max);
      };
      
      function convert_to_radius(amount){
          amount = amount.clamp(0, drawBack.MAX_AMOUNT)
          return .035*Math.sqrt(amount);
      }
        
      String.prototype.format = function () {
          var args = [].slice.call(arguments);
              return this.replace(/(\{\d+\})/g, function (a){
                  return args[+(a.substr(1,a.length-2))||0];
              });
        };
        
      function convert_to_color(amount){
          var color = (amount > 0) ? 
              {r: 50, g:150, b:50} : {r: 150, g:50, b:50};
           if(amount == 0){
              color = {r: 80, g:80, b:80}
            }
          return "rgba({0},{1},{2}, {3})".format(color.r, color.g, color.b, .3);
      }
        
      function drawPath(path, data){
        //Drawing path
        makePath(circleContext, path);
        circleContext.lineWidth = .35;
        circleContext.strokeStyle = convert_to_color(data);
        circleContext.lineCap = "round";
        circleContext.stroke();
      }
        
      function resize(){
      }
      
        
      function particleUpdate(){
          var mapProjection = map.getProjection()
          var canvasWidth = circleLayer.canvas.width;
          var canvasHeight = circleLayer.canvas.height;
          particleContext.clearRect(0, 0, canvasWidth, canvasHeight);
          
          particleContext.setTransform(1, 0, 0, 1, 0, 0);
          var scale = (1 << map.zoom) * resolutionScale;
          particleContext.scale(scale, scale);
          var offset = mapProjection.fromLatLngToPoint(particleLayer.getTopLeft());
          particleContext.translate(-offset.x, -offset.y);
          
          if(refugees.particles.clock){
              refugees.particles.updateClock();
          }
          refugees.particles.draw();
      }

      function update() {
        var mapProjection = map.getProjection()
        var canvasWidth = circleLayer.canvas.width;
        var canvasHeight = circleLayer.canvas.height;
        circleContext.clearRect(0, 0, canvasWidth, canvasHeight);

        circleContext.setTransform(1, 0, 0, 1, 0, 0);
        var scale = (1 << map.zoom) * resolutionScale;
        circleContext.scale(scale, scale);
        var offset = mapProjection.fromLatLngToPoint(circleLayer.getTopLeft());
        circleContext.translate(-offset.x, -offset.y);
           
        //origins
        origin_geo = refugees.geo_data.origin_geo;
        asylum_geo = refugees.geo_data.asylum_geo;
        path_geo = refugees.geo_data.path_geo;
        circle_data = refugees.draw_data.raw;
        path_data = refugees.draw_data.derivative;
        var month = refugees.currentDate.month;
        var year = refugees.currentDate.year;
          
        //origin
        circleContext.lineWidth = drawBack.BASE_STROKE;
        for(var or_key in origin_geo){
            var radius = drawBack.BASE_RADIUS;
            var error = false;
            var originPoint = mapProjection.fromLatLngToPoint(origin_geo[or_key]);
            var currentAmount = 0;
            for(var asyl_country in circle_data){
                var asylumPoint = mapProjection.fromLatLngToPoint(asylum_geo[asyl_country]);
                if(month in circle_data[asyl_country][year] 
                   && or_key in circle_data[asyl_country][year][month]){
                    currentAmount = circle_data[asyl_country][year][month][or_key] || 0;
                    var prevAmount = refugees.prev_shown["origin"][or_key];
                    
                    var interpolated_raw = (currentAmount == prevAmount) ? 
                        currentAmount : prevAmount + Math.ceil((currentAmount - prevAmount)/drawBack.origin_interpolate);
                    radius += convert_to_radius(interpolated_raw);
                    refugees.prev_shown["origin"][or_key] = interpolated_raw;
                    //try{
                        var pointData = path_geo[or_key][asyl_country];
                        var path = refugees.paths[or_key][asyl_country]["path"];
                        drawPath(path, 
                                 path_data[asyl_country][year][month][or_key]);
                    //}catch(error){
                        //console.log("No path between {0} and {1}".format(or_key, asyl_country), error);
                    //}
                }else if(!(month in circle_data[asyl_country][year])){
                    radius = .25;
                    error = true;
                } 
            }
            radius = (radius < 0) ? .1 : radius;
  
            if(!error){
                circleContext.fillStyle = 'rgba(68,153,215, .3)';
                circleContext.strokeStyle = 'rgb(68,153,215)';
            }else{
                circleContext.fillStyle = 'rgba(180, 180, 180, .3)';
                circleContext.strokeStyle = 'rgb(180, 180, 180)';
            }
             //draws circle at origin country
            circleContext.beginPath();
            circleContext.arc(originPoint.x, originPoint.y,radius, 0, 2 * Math.PI, false);
            circleContext.fill();
            circleContext.lineWidth = drawBack.BASE_STROKE;
            circleContext.stroke();
        }
          
        //asylum
          
        circleContext.fillStyle = 'rgba(215, 68, 115, .3)';
        circleContext.strokeStyle = 'rgb(215, 68, 115)';
        for(var asyl_country in circle_data){
            var radius = drawBack.BASE_RADIUS;
            origin_countries = circle_data[asyl_country][year][month]
            var total = 0;
            for (var country in origin_countries){
                total += (origin_countries[country] || 0)
            }
            var prevTotal = refugees.prev_shown["asylum"][asyl_country];
            var interpolated_raw = (total == prevTotal) ? 
                        total : prevTotal + Math.ceil((total - prevTotal)/drawBack.asylum_interpolate);
            refugees.prev_shown["asylum"][asyl_country] = interpolated_raw;
            radius += convert_to_radius(interpolated_raw);
            radius = (radius < 0) ? .1 : radius;
            var asylumPoint = mapProjection.fromLatLngToPoint(asylum_geo[asyl_country]);
            circleContext.beginPath();
            circleContext.arc(asylumPoint.x, asylumPoint.y,radius, 0, 2 * Math.PI, false);
            
            circleContext.fill();
            circleContext.stroke();
        } 
          
        //deaths
        var currentAmount = refugees.deaths[year][month] || 0;
        var prevAmount = refugees.prev_shown["deaths"];

        var interpolated_raw = (currentAmount == prevAmount) ? 
            currentAmount : prevAmount + Math.ceil((currentAmount - prevAmount)/drawBack.origin_interpolate);
        refugees.prev_shown["deaths"] = interpolated_raw;
        var deathsPoint = mapProjection.fromLatLngToPoint(refugees.deaths.location);
        var radius = convert_to_radius(interpolated_raw);
        circleContext.beginPath();
        circleContext.arc(deathsPoint.x, deathsPoint.y,radius, 0, 2 * Math.PI, false);
        circleContext.fillStyle = 'rgba(255, 255, 255, .3)';
        circleContext.fill();
        circleContext.strokeStyle = 'rgb(255, 255, 255)';
        circleContext.stroke();
      }
      
      function getClosestElement(testPoint, threshold){
          var closest = {name:"None Found", type:"", latlon: null};
          var closestDist = Number.MAX_VALUE;
          for(var asyl_key in refugees.geo_data.asylum_geo){
              var latlon = refugees.geo_data.asylum_geo[asyl_key];
              var dist = getDistance(latlon, testPoint);
              if(dist < threshold){
                  return {name:asyl_key, type:"asylum", latlon:latlon};
              }
          }
          for(var or_key in refugees.geo_data.origin_geo){
              var latlon = refugees.geo_data.origin_geo[or_key];
              var dist = getDistance(latlon, testPoint);
              if(dist < threshold){
                  closestDist = dist;
                  return {name:or_key, type:"origin", latlon:latlon};
              }
          }
          
          var latlon = refugees.deaths.location;
          var dist = getDistance(latlon, testPoint);
          
          if(dist < threshold){
              return {name:"deaths", type:"deaths", latlon:latlon};
          }
          
          return {name:"None Found", data:{}, latlon: null};
      }
      
      function processMapHover(event){
          var closest = getClosestElement(event.latLng, 75000);
          drawBack.lasthover = drawBack.hover
          if(closest.latlon != null){
              if(drawBack.hover == {} || drawBack.hover.name != closest.name){
                  drawBack.hover = closest;
              }
          }else{
              drawBack.hover = {};
          }
          updateHoverBox();
      }
      //from https://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
      function numberWithCommas(x) {
          return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
        
      function updateHoverBox(){
          var hoverHTML = [];
          hoverHTML.push('<div id="hoverbox">');
          if(!$.isEmptyObject(drawBack.hover)){
              var year = refugees.currentDate.year;
              var month = refugees.currentDate.month;

              var name = drawBack.hover.name;
              switch(drawBack.hover.type){
                  case "asylum":
                      hoverHTML.push('<p><strong>',name,':</strong> asylum country</p>');
                      var total = 0
                      var data = refugees.draw_data.raw[name][year][month];
                      for(var or_key in data){
                          var amount = data[or_key];
                          hoverHTML.push('<p>From <strong>',or_key,'</strong>: ',numberWithCommas(amount),'</p>');
                          total += amount;
                      }
                      hoverHTML.push('<p>Total: ',numberWithCommas(total),'</p>');
                      break;
                  case "origin":
                      hoverHTML.push('<p><strong>',name,':</strong> origin country</p>');
                      var total = 0;
                      for(var asyl_key in refugees.draw_data.raw){
                          var data = refugees.draw_data.raw[asyl_key][year][month];
                          if(name in data){
                              var amount = data[name];
                              hoverHTML.push('<p>To <strong>',asyl_key,'</strong>: ',numberWithCommas(amount),'</p>');
                              total += amount;
                          }  
                      }
                      hoverHTML.push('<p>Total: ',numberWithCommas(total),'</p>');
                      break;
                  case "deaths":
                      hoverHTML.push('<p>Deaths: ',numberWithCommas(refugees.deaths[year][month]),'</p>');
                      break;
                  default:
                      console.log(drawBack.hover);
              }
          }else{
              if(drawBack.infowindow){
                  drawBack.infowindow.close()
              }
              drawBack.infowindow = null;
              return;
          }
          var dateString = '';
          switch(month){
              case 1:
                  dateString = "January ";
                  break;
              case 2:
                  dateString = "February ";
                  break;
              case 3:
                  dateString = "March ";
                  break;
              case 4:
                  dateString = "April ";
                  break;
              case 5:
                  dateString = "May ";
                  break;
              case 6:
                  dateString = "June ";
                  break;
              case 7:
                  dateString = "July ";
                  break;
              case 8:
                  dateString = "August ";
                  break;
              case 9:
                  dateString = "September ";
                  break;
              case 10:
                  dateString = "October ";
                  break;
              case 11:
                  dateString = "November ";
                  break;
              case 12:
                  dateString = "December ";
                  break;
          }
          hoverHTML.push('<p>',dateString,year,'</p>')
          hoverHTML.push('</div>');
          if(drawBack.infowindow){
              drawBack.infowindow.setContent(hoverHTML.join(''));
          }else{
              drawBack.infowindow = new google.maps.InfoWindow({
                  content: hoverHTML.join(''),
                  position: drawBack.hover.latlon
              });
              drawBack.infowindow.open(map);
          }
      }
        
      function initMap(){
        // initialize the map
        var mapOptions = {
          zoom: 4,
          minZoom: 3,
          center: new google.maps.LatLng(34.17497, 22.09833),
          mapTypeId: google.maps.MapTypeId.TERRAIN,
          keyboardShortcuts: false,
          styles: [
                {
                    "featureType": "all",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "saturation": 36
                        },
                        {
                            "color": "#999999"
                        },
                        {
                            "lightness": 40
                        }
                    ]
                },
                {
                    "featureType": "all",
                    "elementType": "labels.text.stroke",
                    "stylers": [
                        {
                            "visibility": "on"
                        },
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 16
                        }
                    ]
                },
                {
                    "featureType": "all",
                    "elementType": "labels.icon",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "featureType": "administrative",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 20
                        }
                    ]
                },
                {
                    "featureType": "administrative",
                    "elementType": "geometry.stroke",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 17
                        },
                        {
                            "weight": 1.2
                        }
                    ]
                },
                {
                    "featureType": "landscape",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 20
                        }
                    ]
                },
                {
                    "featureType": "poi",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 21
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 17
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry.stroke",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 29
                        },
                        {
                            "weight": 0.2
                        }
                    ]
                },
                {
                    "featureType": "road.arterial",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 18
                        }
                    ]
                },
                {
                    "featureType": "road.local",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 16
                        }
                    ]
                },
                {
                    "featureType": "transit",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#000000"
                        },
                        {
                            "lightness": 19
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color":"#0b2929"
                        },
                        {
                            "lightness": 17
                        }
                    ]
                }
            ]
        };
        var mapDiv = document.getElementById('map-div');
        return new google.maps.Map(mapDiv, mapOptions);
      }
        
      function initCanvasLayer(updateHandler, animated){
        // initialize the canvasLayer
        var canvasLayerOptions = {
          map: map,
          resizeHandler: resize,
          animate: animated,
          updateHandler: updateHandler,
          resolutionScale: resolutionScale
        };
        return new CanvasLayer(canvasLayerOptions);
      }
      
      function init() {
        map = initMap();
          
        load(refugees.geo_url).then(function(response){
            geo_handler(response);
        }, function(error){
            console.error("Failed!", error);
        }).then(function(){
            load(refugees.draw_url).then(function(response){
                draw_handler(response);
            }, function(error){
                console.error("Failed!", error);
            }).then(function(){
                google.maps.event.addListenerOnce(map, 'idle', function(){
                    updatePath();
                    
                    circleLayer = initCanvasLayer(update, false);
                    circleContext = circleLayer.canvas.getContext('2d');
                    
                    particleLayer = initCanvasLayer(particleUpdate, true);
                    particleContext = particleLayer.canvas.getContext('2d');
                    
                    var el = document.getElementById("loading");
                    el.style['display'] = 'none';
                    refugees.currentDate = new Date_M_Y(1,2014);
                    $('#m1y2014').addClass('cursor');
                    upDate();
                });
                google.maps.event.addListener(map, 'mousemove', processMapHover);
            });
        });
          
        $('#circle').click(togglePlayPause);
        $('.year').on("mousedown", ".valid", function(event){
                playBack.mouseDown = true;
                $('.valid').removeClass('cursor');
                $(this).addClass('cursor');
                upDate();
        })
        .on("mousemove", ".valid", function(event){
          if(playBack.mouseDown){
            $('.valid').removeClass('cursor');
            $(this).addClass('cursor');
            upDate();
          }
        })
        .on("mouseup", ".valid", function(){
              playBack.mouseDown = false;
        })
        .addClass('noselect');


        $('.year').addClass('noselect');

        $('document').on("mouseup", function(){
              playBack.mouseDown = false;
        });
          
        $('body').keyup(function(e){
           if(e.keyCode == 32){
               // space bar
               togglePlayPause();
           }else if(e.keyCode == 37){
               //left arrow
               decrementMonth();
           }else if(e.keyCode == 39){
               //right arrow
               incrementMonth();
           }
        });
      }
        
      document.addEventListener('DOMContentLoaded', init, false);
      window.addEventListener('resize', function () {  google.maps.event.trigger(map, 'resize') }, false);

    </script>
  </head>
  <body>
    <div id="map-div"></div>
    <div id="time-slider">
        <div id="play-button">
          <div id="circle">
            <div class="play"></div>
          </div>
        </div>
        <div class="year" id="y2014" data-year="2014" style="border-top: 6px solid rgb(68, 215, 168); background-color:rgba(68, 215, 168, .5)">
            <div class="month" id="m1y2014" data-month="1"><div class="line"></div><p>Jan</p></div>
            <div class="month" id="m2y2014" data-month="2"><div class="line"></div><p>Feb</p></div>
            <div class="month" id="m3y2014" data-month="3"><div class="line"></div><p>Mar</p></div>
            <div class="month" id="m4y2014" data-month="4"><div class="line"></div><p>Apr</p></div>
            <div class="month" id="m5y2014" data-month="5"><div class="line"></div><p>May</p></div>
            <div class="month" id="m6y2014" data-month="6"><div class="line"></div><p>Jun</p></div>
            <div class="month" id="m7y2014" data-month="7"><div class="line"></div><p>Jul</p></div>
            <div class="month" id="m8y2014" data-month="8"><div class="line"></div><p>Aug</p></div>
            <div class="month" id="m9y2014" data-month="9"><div class="line"></div><p>Sep</p></div>
            <div class="month" id="m10y2014" data-month="10"><div class="line"></div><p>Oct</p></div>
            <div class="month" id="m11y2014" data-month="11"><div class="line"></div><p>Nov</p></div>
            <div class="month" id="m12y2014" data-month="12"><div class="line"></div><p>Dec</p></div>
            <p>2014</p>
        </div>
        <div class="year" id="y2015" data-year="2015" style="border-top: 6px solid rgb(68, 118, 215); background-color:rgba(68, 189, 215, .5)">
            <div class="month" id="m1y2015" data-month="1"><div class="line"></div><p>Jan</p></div>
            <div class="month" id="m2y2015" data-month="2"><div class="line"></div><p>Feb</p></div>
            <div class="month" id="m3y2015" data-month="3"><div class="line"></div><p>Mar</p></div>
            <div class="month" id="m4y2015" data-month="4"><div class="line"></div><p>Apr</p></div>
            <div class="month" id="m5y2015" data-month="5"><div class="line"></div><p>May</p></div>
            <div class="month" id="m6y2015" data-month="6"><div class="line"></div><p>Jun</p></div>
            <div class="month" id="m7y2015" data-month="7"><div class="line"></div><p>Jul</p></div>
            <div class="month" id="m8y2015" data-month="8"><div class="line"></div><p>Aug</p></div>
            <div class="month" id="m9y2015" data-month="9"><div class="line"></div><p>Sep</p></div>
            <div class="month" id="m10y2015" data-month="10"><div class="line"></div><p>Oct</p></div>
            <div class="month" id="m11y2015" data-month="11"><div class="line"></div><p>Nov</p></div>
            <div class="month" id="m12y2015" data-month="12"><div class="line"></div><p>Dec</p></div>
            <p>2015</p>
        </div>
        <div class="year" id="y2016" data-year="2016" style="border-top: 6px solid rgb(215, 68, 115); background-color:rgba(215, 68, 115, .5)">
            <div class="month" id="m1y2016" data-month="1"><div class="line"></div><p>Jan</p></div>
            <div class="month" id="m2y2016" data-month="2"><div class="line"></div><p>Feb</p></div>
            <div class="month" id="m3y2016" data-month="3"><div class="line"></div><p>Mar</p></div>
            <div class="month" id="m4y2016" data-month="4"><div class="line"></div><p>Apr</p></div>
            <div class="month" id="m5y2016" data-month="5"><div class="line"></div><p>May</p></div>
            <div class="month" id="m6y2016" data-month="6"><div class="line"></div><p>Jun</p></div>
            <div class="month" id="m7y2016" data-month="7"><div class="line"></div><p>Jul</p></div>
            <div class="month" id="m8y2016" data-month="8"><div class="line"></div><p>Aug</p></div>
            <div class="month" id="m9y2016" data-month="9"><div class="line"></div><p>Sep</p></div>
            <div class="month" id="m10y2016" data-month="10"><div class="line"></div><p>Oct</p></div>
            <div class="month" id="m11y2016" data-month="11"><div class="line"></div><p>Nov</p></div>
            <div class="month" id="m12y2016" data-month="12"><div class="line"></div><p>Dec</p></div>
            <p>2016</p>
        </div>
      </div>
      <div id="loading"></div>
  </body>
</html>